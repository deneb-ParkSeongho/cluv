<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shop.mapper.BestItemMapper">

    <!--  reuse select  -->
    <sql id="select_items">
        select sell_item.item_id, sell_item.item_nm, sell_item.item_detail, img.img_url, sell_item.price
        from (
             select item_id, item_nm, item_detail, price
               from it1661.item
              where item_sell_status = 'SELL'
             ) sell_item
    </sql>

    <!--  reuse join  -->
    <sql id="join">
          join it1661.order_item orders
            on orders.item_id = sell_item.item_id
          join it1661.item_img img
            on img.item_id = sell_item.item_id
    </sql>

    <!--  reuse group by and order by  -->
    <sql id="group_order">
        group by sell_item.item_id
        order by count(orders.count) desc
                 limit 10;
    </sql>


    <!--    bestItemByDays    -->
    <select id="getBestItemByDays" resultType="com.shop.dto.BestItemDto">
        <include refid="select_items"></include>
        <include refid="join"></include>
        where date_format(orders.reg_time,'%Y%m%d') = date_format(now(),'%Y%m%d')
        <include refid="group_order"></include>
    </select>

    <!--   bestItemByWeek -->
    <select id="getBestItemByWeek" resultType="com.shop.dto.BestItemDto">
        <include refid="select_items"></include>
        <include refid="join"></include>
        where orders.reg_time between date_format(now(),'%Y%m%d')-(dayofweek(now())-1)
          and date_format(date_sub(now(), interval dayofweek(now())-7 DAY),'%Y%m%d')
        <include refid="group_order"></include>
    </select>

    <!--   bestItemByMonth -->
    <select id="getBestItemByMonth" resultType="com.shop.dto.BestItemDto">
        <include refid="select_items"></include>
        <include refid="join"></include>
        where date_format(orders.reg_time,'%Y%m%d') between date_format(LAST_DAY(NOW() - interval 1 month)+ interval 1 DAY,'%Y%m%d')
          and date_format(LAST_DAY(NOW() - interval 0 month),'%Y%m%d')
        <include refid="group_order"></include>
    </select>

</mapper>
